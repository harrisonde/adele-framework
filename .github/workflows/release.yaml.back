name: framework release workflow

on:
  push:
    branches:
      - "main"
      - "ci/*"
      - "hotfix/*"
      - "release/*"
    tags:
      - '[0-9]+.[0-9]+.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?'

jobs:
  release:
    runs-on: ["self-hosted", "macOS", "ARM64", "cidekar", "macos-arm64"]
    steps:
      - name: checkout the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: add go (production)
        uses: actions/setup-go@v5
        if: ${{ !env.ACT }}
        with:
          go-version: '1.21'

      - name: add go (testing)
        if: ${{ env.ACT }}
        run: |
          echo "Checking for Go installation..."

          if command -v go &> /dev/null; then
            echo "✅ Go already available: $(go version)"
          else
            echo "Installing Go without package manager..."

            # Create directory in user space (no sudo needed)
            mkdir -p $HOME/go-install
            cd $HOME/go-install

            # Download Go using curl (more likely to be available than wget)
            if command -v curl &> /dev/null; then
              echo "Downloading Go 1.21.5..."
              curl -sL https://go.dev/dl/go1.21.5.linux-amd64.tar.gz -o go.tar.gz

              # Extract to home directory (no root needed)
              tar -xzf go.tar.gz

              # Set up paths
              export GOROOT="$HOME/go-install/go"
              export PATH="$GOROOT/bin:$PATH"
              echo "$GOROOT/bin" >> $GITHUB_PATH

              echo "✅ Go installed to: $GOROOT"
            else
              echo "❌ curl not available, cannot install Go"
              exit 1
            fi
          fi

          # Final verification
          echo "Go version check:"
          go version

      - name: Setup Go directories for act
        if: ${{ env.ACT }}
        run: |
          mkdir -p /github/workspace/.gocache
          mkdir -p /github/workspace/.gotmp
          chmod -R 777 /github/workspace/.gocache /github/workspace/.gotmp

      - name: write version tag
        run: |
          GITHUB_REF_TAG=${{env.GITHUB_REF_TAG}} go run .github/workflows/semantic-release-write-version.go
          cat adele.go | grep  "const Version*"
          echo "✅ Version tag written to code"
        env:
          GITHUB_REF_TAG: ${{env.GITHUB_REF_TAG}}

      - name: configure act for github (testing)
        if: ${{ env.ACT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          # Git configuration
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{secrets.GITHUB_USER}}/adele-framework.git
          git config --global user.name "continuous integration"
          git config --global user.email "no-reply@cidekar.com"
          git checkout -b ${{env.GITHUB_REF_NAME}} 2>/dev/null || git checkout ${{env.GITHUB_REF_NAME}}
          git commit -a -m "continuous integration build artifacts ${{env.GITHUB_REF_NAME}}"
          git push --set-upstream origin ${{env.GITHUB_REF_NAME}}
          # Automate tag
          git tag ${{env.GITHUB_REF_TAG}}
          git push --set-upstream origin ${{env.GITHUB_REF_NAME}}

      - name: commit source code
        if: ${{ !env.ACT }}
        run: |
          if git diff --cached --quiet && git diff --quiet; then
            echo "✅ No changes to commit"
          else
            git config --global user.name "continuous integration"
            git config --global user.email "no-reply@cidekar.com"
            git checkout -b ${{env.GITHUB_REF_NAME}} 2>/dev/null || git checkout ${{env.GITHUB_REF_NAME}}
            git commit -a -m "continuous integration build artifacts ${{env.GITHUB_REF_NAME}}"
            git push --set-upstream origin ${{env.GITHUB_REF_NAME}}
            echo "✅ Git commit completed successfully"
          fi

      - name: install quill
        run: curl -sSfL https://raw.githubusercontent.com/anchore/quill/main/install.sh | sh -s -- -b .tmp/quill v0.4.1

      # - name: checkout branch
      #   run: |
      #     echo "⚙️ Setup git configuration..."
      #     git config --global user.name "continuous integration"
      #     git config --global user.email "no-reply@cidekar.com"

      #     # Create a temporary ci branch
      #     git checkout -b ci/${{ github.ref_name }} 2>/dev/null || git checkout ci/${{ github.ref_name }}

      - name: run goreleaser
        run: |
          if ! command -v goreleaser &> /dev/null; then
            echo "Installing GoReleaser..."
            go install github.com/goreleaser/goreleaser@latest
            echo "✅ GoReleaser installed"
          else
            echo "✅ GoReleaser already available"
          fi
          goreleaser release --clean --skip-validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Certificate Type: Developer ID Application
          # Base64 encoded contents or path to signing private key and certificate from Apple (this is in the form of a ".p12" file)
          QUILL_SIGN_P12: ${{ secrets.QUILL_SIGN_P12 }}
          QUILL_SIGN_PASSWORD: ${{ secrets.QUILL_SIGN_PASSWORD }}
          # App store connect team API Key with App Manager scope
          # The .p8 key file path or its base64'd contents.
          QUILL_NOTARY_KEY: ${{ secrets.QUILL_NOTARY_KEY }}
          # The issuer ID.
          # Its the UUID you see when creating the App Store Connect key.
          QUILL_NOTARY_KEY_ID: ${{ secrets.QUILL_NOTARY_KEY_ID }}
          # The issuer ID.
          # Its the UUID you see when creating the App Store Connect key.
          QUILL_NOTARY_ISSUER: ${{ secrets.QUILL_NOTARY_ISSUER }}
